---
title: "TABI_Models_Comparison"
author: "Isobel Beasley"
date: "Last Updated 21/12/2019"
output: 
html_document: 
  toc: yes
  toc_depth: 3
  number_sections: true
  theme: readable
  highlight: null
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE, fig.height=10, fig.width = 12, warning=FALSE, message=FALSE, eval = TRUE, fig.show=TRUE, fig.align='center', out.width = '100%')
```

## Load Required Packages

```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(rstan)
library(gridExtra)
#TABI
if("package:TABI" %in% search()) detach("package:TABI", unload=TRUE, force=TRUE); library(TABI)  

#Required TCGA (Data, just transcript, CAPRA_S, and normalised gene count columns)
load("/stornext/Home/data/allstaff/b/beasley.i/TABI/dev/PC_TCGA.rda")
```

# NUSAP1

## Data Preparation for TABI 

```{r}
Test_Real_NUSAP1<-PC_TCGA %>% 
  filter(transcript=="NUSAP1") %>% #Select Gene of Interest
  select(-transcript) %>% #Remove Gene Name Column
  rename(NUSAP1= `read count normalised` , CAPRA_S = `CAPRA-S`) %>% #Rename column labels
  filter(is.na(CAPRA_S)==F, is.na(NUSAP1)==F) #Remove any NA values

CAPRA_S <- Test_Real_NUSAP1$CAPRA_S #Define CAPRA_S Variable 

#Plot gene count vs CAPRA_S score on log scale

Test_Real_NUSAP1 %>% ggplot(aes(x=CAPRA_S, y=NUSAP1+1)) + 
  geom_point() + 
  scale_y_log10() + 
  labs(title="NUSAP1 Gene Count vs CAPRA_S")


# Plot gene count vs CAPRA_S score on natural scale 

Test_Real_NUSAP1 %>% ggplot(aes(x=CAPRA_S, y=NUSAP1+1)) + 
  geom_point() + 
  labs(title="NUSAP1 Gene Count vs CAPRA_S")
```

## Run TABI

```{r}
# Model with vertical translation, fitting sigmoidal curve to log gene counts

TABI_NUSAP1_Vert_Log<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_NUSAP1, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_vert_log_space.stan", auto_write = F))
  

# Model with no vertical translation, fitting sigmoidal curve to log gene counts

TABI_NUSAP1_Log<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_NUSAP1, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_log_space.stan", auto_write = F))


# Model with vertical translation, fitting sigmoidal curve in the natural scale

TABI_NUSAP1_Vert_Nat<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_NUSAP1, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene.stan", auto_write = F))
rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene.stan", auto_write = F)


# Model with no vertical translation, fitting sigmoidal curve in the natural scale 

TABI_NUSAP1_Nat<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_NUSAP1, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_vert_trans.stan", auto_write = F))
```

## Posterior Diagnostic Checks 

```{r}
traceplot(TABI_NUSAP1_Vert_Log$fit)

traceplot(TABI_NUSAP1_Log$fit)

traceplot(TABI_NUSAP1_Vert_Nat$fit)

traceplot(TABI_NUSAP1_Nat$fit)
```

##  What does each TABI model estimate/sample for this gene? / How does this compare to the actual data?

```{r}
Test_Real_NUSAP1 %>% 
  ggplot(aes(x=CAPRA_S, y=NUSAP1+1)) + 
  geom_point() + #Plot actual data for NUSAP1 in black points
  labs(title="", y="read count normalised") + 
  #Plot in red Model Generated Quantities (Vertical Translation, Fitting in Log Space)
  geom_point(aes(x=x_cord, y=estimate), 
             data = TABI_NUSAP1_Vert_Log$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "red") + 
  #Plot in blue Model Generated Quantities (No Translation, Fitting in Log Space)
  geom_point(aes(x=x_cord, y=estimate), 
             data = TABI_NUSAP1_Log$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "blue", alpha=0.5) +
  #Plot in light green Model Generated Quantities (Vertical Translation, Fitting in Natural Space)
  geom_point(aes(x=x_cord, y=estimate),
             data = TABI_NUSAP1_Vert_Nat$generated_quantities %>%
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "light green", alpha=0.5) + 
    #Plot in red Model Generated Quantities (No Translation, Fitting in Natural Space)
  geom_point(aes(x=x_cord, y=estimate),
             data = TABI_NUSAP1_Nat$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "light blue", alpha=0.5) +
  #Scale log gene counts 
  scale_y_log10() +
  ggtitle("Red(Log Space, Vertical Trans), Blue (Log Space), Green(Vert Trans, Real Space), Light Blue (Real Space)" )


#Arrange each into separate plots for easy viewing 
#(high degree of overlap above makes it hard to ascertain improvements)

#Have the real data as base plot in all plots (in black)
base_plot <- Test_Real_NUSAP1 %>% 
  ggplot(aes(x=CAPRA_S, y=NUSAP1+1)) + 
  geom_point()


#Arrangement of plots as below
#Colours are same as above 
grid.arrange(p1 = base_plot + 
               geom_point(aes(x=x_cord, y=estimate), 
                          data = TABI_NUSAP1_Vert_Log$generated_quantities %>% 
                            ungroup() %>% 
                            mutate(x_cord = CAPRA_S), 
                          color = "red") +
               scale_y_log10(), 
             p2 = base_plot +
              geom_point(aes(x=x_cord, y=estimate), 
                         data = TABI_NUSAP1_Log$generated_quantities %>% 
                           ungroup() %>% 
                           mutate(x_cord = CAPRA_S), 
                         color = "blue") +
               scale_y_log10(),
             p3 = base_plot + 
               geom_point(aes(x=x_cord, y=estimate),
                          data = TABI_NUSAP1_Vert_Nat$generated_quantities %>%
                            ungroup() %>% 
                            mutate(x_cord = CAPRA_S), 
                          color = "light green") + 
               scale_y_log10(),
             p4 = base_plot +   
               geom_point(aes(x=x_cord, y=estimate),
                          data = TABI_NUSAP1_Nat$generated_quantities %>% 
                            ungroup() %>% mutate(x_cord = CAPRA_S), 
                          color = "light blue") +
               scale_y_log10(), 
             ncol=2, #Two rows, two columns of plots
             #Title labelling colours of each plot
             top = "Red(Log Space, Vertical Trans), Blue (Log Space), Green(Vert Trans, Real Space), Light Blue (Real Space)" ) 



```

# CDKN2B

## Data Preparation for TABI 

```{r}
Test_Real_CDKN2B<-PC_TCGA %>% 
  filter(transcript=="CDKN2B") %>% 
  select(-transcript) %>% 
  rename(CDKN2B= `read count normalised` , CAPRA_S = `CAPRA-S`) %>% 
  filter(is.na(CAPRA_S)==F, is.na(CDKN2B)==F)


#Define CAPRA_S
CAPRA_S <- Test_Real_CDKN2B$CAPRA_S


#Plot gene count vs CAPRA_S score on log scale

Test_Real_CDKN2B %>% ggplot(aes(x=CAPRA_S, y=CDKN2B+1)) + 
  geom_point() + 
  scale_y_log10() + 
  labs(title="CDKN2B Gene Count vs CAPRA_S")


# Plot gene count vs CAPRA_S score on natural scale 

Test_Real_CDKN2B %>% ggplot(aes(x=CAPRA_S, y=CDKN2B+1)) + 
  geom_point() + 
  labs(title="CDKN2B Gene Count vs CAPRA_S")
```

## Run TABI

```{r}
# Model with vertical translation, fitting sigmoidal curve to log gene counts

TABI_CDKN2B_Vert_Log<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_CDKN2B, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_vert_log_space.stan", auto_write = F))
  

# Model with no vertical translation, fitting sigmoidal curve to log gene counts

TABI_CDKN2B_Log<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_CDKN2B, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_log_space.stan", auto_write = F))


# Model with vertical translation, fitting sigmoidal curve in the natural scale

TABI_CDKN2B_Vert_Nat<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_CDKN2B, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene.stan", auto_write = F))
rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene.stan", auto_write = F)


# Model with no vertical translation, fitting sigmoidal curve in the natural scale 

TABI_CDKN2B_Nat<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_CDKN2B, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_vert_trans.stan", auto_write = F))
```


## Posterior Diagnostic Checks 

```{r}
traceplot(TABI_CDKN2B_Vert_Log$fit)

traceplot(TABI_CDKN2B_Log$fit)

traceplot(TABI_CDKN2B_Vert_Nat$fit)

traceplot(TABI_CDKN2B_Nat$fit)
```

##  What does each TABI model estimate/sample for this gene? / How does this compare to the actual data?

```{r}
Test_Real_CDKN2B %>% 
  ggplot(aes(x=CAPRA_S, y=CDKN2B+1)) + 
  geom_point() + #Plot actual data for CDKN2B in black points
  labs(title="", y="read count normalised") + 
  #Plot in red Model Generated Quantities (Vertical Translation, Fitting in Log Space)
  geom_point(aes(x=x_cord, y=estimate), 
             data = TABI_CDKN2B_Vert_Log$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "red") + 
  #Plot in blue Model Generated Quantities (No Translation, Fitting in Log Space)
  geom_point(aes(x=x_cord, y=estimate), 
             data = TABI_CDKN2B_Log$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "blue", alpha=0.5) +
  #Plot in light green Model Generated Quantities (Vertical Translation, Fitting in Natural Space)
  geom_point(aes(x=x_cord, y=estimate),
             data = TABI_CDKN2B_Vert_Nat$generated_quantities %>%
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "light green", alpha=0.5) + 
    #Plot in red Model Generated Quantities (No Translation, Fitting in Natural Space)
  geom_point(aes(x=x_cord, y=estimate),
             data = TABI_CDKN2B_Nat$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "light blue", alpha=0.5) +
  #Scale log gene counts 
  scale_y_log10() +
  ggtitle("Red(Log Space, Vertical Trans), Blue (Log Space), Green(Vert Trans, Real Space), Light Blue (Real Space)" )


#Arrange each into separate plots for easy viewing 
#(high degree of overlap above makes it hard to ascertain improvements)

#Have the real data as base plot in all plots (in black)
base_plot <- Test_Real_CDKN2B %>% 
  ggplot(aes(x=CAPRA_S, y=CDKN2B+1)) + 
  geom_point()


#Arrangement of plots as below
#Colours are same as above 
grid.arrange(p1 = base_plot + 
               geom_point(aes(x=x_cord, y=estimate), 
                          data = TABI_CDKN2B_Vert_Log$generated_quantities %>% 
                            ungroup() %>% 
                            mutate(x_cord = CAPRA_S), 
                          color = "red") +
               scale_y_log10(), 
             p2 = base_plot +
              geom_point(aes(x=x_cord, y=estimate), 
                         data = TABI_CDKN2B_Log$generated_quantities %>% 
                           ungroup() %>% 
                           mutate(x_cord = CAPRA_S), 
                         color = "blue") +
               scale_y_log10(),
             p3 = base_plot + 
               geom_point(aes(x=x_cord, y=estimate),
                          data = TABI_CDKN2B_Vert_Nat$generated_quantities %>%
                            ungroup() %>% 
                            mutate(x_cord = CAPRA_S), 
                          color = "light green") +
              scale_y_log10(),
             p4 = base_plot +   
               geom_point(aes(x=x_cord, y=estimate),
                          data = TABI_CDKN2B_Nat$generated_quantities %>% 
                            ungroup() %>% mutate(x_cord = CAPRA_S), 
                          color = "light blue") +
              scale_y_log10(),
             ncol=2, #Two rows, two columns of plots
             #Title labelling colours of each plot
             top = "Red(Log Space, Vertical Trans), Blue (Log Space), Green(Vert Trans, Real Space), Light Blue (Real Space)" ) 



```

# SLC22A3

## Data Preparation for TABI 

```{r}
Test_Real_SLC22A3<-PC_TCGA %>% 
  filter(transcript=="SLC22A3") %>% 
  select(-transcript) %>% 
  rename(SLC22A3= `read count normalised` , CAPRA_S = `CAPRA-S`) %>% 
  filter(is.na(CAPRA_S)==F, is.na(SLC22A3)==F)

CAPRA_S <- Test_Real_SLC22A3$CAPRA_S
#Plot gene count vs CAPRA_S score on log scale

Test_Real_SLC22A3 %>% ggplot(aes(x=CAPRA_S, y=SLC22A3+1)) + 
  geom_point() + 
  scale_y_log10() + 
  labs(title="SLC22A3 Gene Count vs CAPRA_S")


# Plot gene count vs CAPRA_S score on natural scale 

Test_Real_SLC22A3 %>% ggplot(aes(x=CAPRA_S, y=SLC22A3+1)) + 
  geom_point() + 
  labs(title="SLC22A3 Gene Count vs CAPRA_S")
```

## Run TABI

```{r}
# Model with vertical translation, fitting sigmoidal curve to log gene counts

TABI_SLC22A3_Vert_Log<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_SLC22A3, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_vert_log_space.stan", auto_write = F))
  

# Model with no vertical translation, fitting sigmoidal curve to log gene counts

TABI_SLC22A3_Log<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_SLC22A3, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_log_space.stan", auto_write = F))


# Model with vertical translation, fitting sigmoidal curve in the natural scale

TABI_SLC22A3_Vert_Nat<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_SLC22A3, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene.stan", auto_write = F))
rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene.stan", auto_write = F)


# Model with no vertical translation, fitting sigmoidal curve in the natural scale 

TABI_SLC22A3_Nat<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_SLC22A3, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_vert_trans.stan", auto_write = F))
```

## Posterior Diagnostic Checks 

```{r}
traceplot(TABI_SLC22A3_Vert_Log$fit)

traceplot(TABI_SLC22A3_Log$fit)

traceplot(TABI_SLC22A3_Vert_Nat$fit)

traceplot(TABI_SLC22A3_Nat$fit)
```

##  What does each TABI model estimate/sample for this gene? / How does this compare to the actual data?

```{r}
Test_Real_SLC22A3 %>% 
  ggplot(aes(x=CAPRA_S, y=SLC22A3+1)) + 
  geom_point() + #Plot actual data for SLC22A3 in black points
  labs(title="", y="read count normalised") + 
  #Plot in red Model Generated Quantities (Vertical Translation, Fitting in Log Space)
  geom_point(aes(x=x_cord, y=estimate), 
             data = TABI_SLC22A3_Vert_Log$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "red") + 
  #Plot in blue Model Generated Quantities (No Translation, Fitting in Log Space)
  geom_point(aes(x=x_cord, y=estimate), 
             data = TABI_SLC22A3_Log$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "blue", alpha=0.5) +
  #Plot in light green Model Generated Quantities (Vertical Translation, Fitting in Natural Space)
  geom_point(aes(x=x_cord, y=estimate),
             data = TABI_SLC22A3_Vert_Nat$generated_quantities %>%
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "light green", alpha=0.5) + 
    #Plot in red Model Generated Quantities (No Translation, Fitting in Natural Space)
  geom_point(aes(x=x_cord, y=estimate),
             data = TABI_SLC22A3_Nat$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "light blue", alpha=0.5) +
  #Scale log gene counts 
  scale_y_log10() +
  ggtitle("Red(Log Space, Vertical Trans), Blue (Log Space), Green(Vert Trans, Real Space), Light Blue (Real Space)" )


#Arrange each into separate plots for easy viewing 
#(high degree of overlap above makes it hard to ascertain improvements)

#Have the real data as base plot in all plots (in black)
base_plot <- Test_Real_SLC22A3 %>% 
  ggplot(aes(x=CAPRA_S, y=SLC22A3+1)) + 
  geom_point()


#Arrangement of plots as below
#Colours are same as above 
grid.arrange(p1 = base_plot + 
               geom_point(aes(x=x_cord, y=estimate), 
                          data = TABI_SLC22A3_Vert_Log$generated_quantities %>% 
                            ungroup() %>% 
                            mutate(x_cord = CAPRA_S), 
                          color = "red") +
             scale_y_log10(), 
             p2 = base_plot +
              geom_point(aes(x=x_cord, y=estimate), 
                         data = TABI_SLC22A3_Log$generated_quantities %>% 
                           ungroup() %>% 
                           mutate(x_cord = CAPRA_S), 
                         color = "blue") +
               scale_y_log10(),
             p3 = base_plot + 
               geom_point(aes(x=x_cord, y=estimate),
                          data = TABI_SLC22A3_Vert_Nat$generated_quantities %>%
                            ungroup() %>% 
                            mutate(x_cord = CAPRA_S), 
                          color = "light green") +
               scale_y_log10(),
             p4 = base_plot +   
               geom_point(aes(x=x_cord, y=estimate),
                          data = TABI_SLC22A3_Nat$generated_quantities %>% 
                            ungroup() %>% mutate(x_cord = CAPRA_S), 
                          color = "light blue") +
               scale_y_log10(), 
             ncol=2, #Two rows, two columns of plots
             #Title labelling colours of each plot
             top = "Red(Log Space, Vertical Trans), Blue (Log Space), Green(Vert Trans, Real Space), Light Blue (Real Space)" ) 



```

# KIF23

## Data Preparation for TABI 

```{r}
Test_Real_KIF23<-PC_TCGA %>% 
  filter(transcript=="KIF23") %>% 
  select(-transcript) %>% 
  rename(KIF23= `read count normalised` , CAPRA_S = `CAPRA-S`) %>% 
  filter(is.na(CAPRA_S)==F, is.na(KIF23)==F)

CAPRA_S <- Test_Real_KIF23$CAPRA_S

#Plot gene count vs CAPRA_S score on log scale

Test_Real_KIF23 %>% ggplot(aes(x=CAPRA_S, y=KIF23+1)) + 
  geom_point() + 
  scale_y_log10() + 
  labs(title="KIF23 Gene Count vs CAPRA_S")


# Plot gene count vs CAPRA_S score on natural scale 

Test_Real_KIF23 %>% ggplot(aes(x=CAPRA_S, y=KIF23+1)) + 
  geom_point() + 
  labs(title="KIF23 Gene Count vs CAPRA_S")
```

## Run TABI

```{r}
# Model with vertical translation, fitting sigmoidal curve to log gene counts

TABI_KIF23_Vert_Log<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_KIF23, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_vert_log_space.stan", auto_write = F))
  

# Model with no vertical translation, fitting sigmoidal curve to log gene counts

TABI_KIF23_Log<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_KIF23, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_log_space.stan", auto_write = F))


# Model with vertical translation, fitting sigmoidal curve in the natural scale

TABI_KIF23_Vert_Nat<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_KIF23, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene.stan", auto_write = F))
rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene.stan", auto_write = F)


# Model with no vertical translation, fitting sigmoidal curve in the natural scale 

TABI_KIF23_Nat<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_KIF23, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_vert_trans.stan", auto_write = F))
```

## Posterior Diagnostic Checks 

```{r}
traceplot(TABI_KIF23_Vert_Log$fit)

traceplot(TABI_KIF23_Log$fit)

traceplot(TABI_KIF23_Vert_Nat$fit)

traceplot(TABI_KIF23_Nat$fit)
```

##  What does each TABI model estimate/sample for this gene? / How does this compare to the actual data?

```{r}
Test_Real_KIF23 %>% 
  ggplot(aes(x=CAPRA_S, y=KIF23+1)) + 
  geom_point() + #Plot actual data for KIF23 in black points
  labs(title="", y="read count normalised") + 
  #Plot in red Model Generated Quantities (Vertical Translation, Fitting in Log Space)
  geom_point(aes(x=x_cord, y=estimate), 
             data = TABI_KIF23_Vert_Log$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "red") + 
  #Plot in blue Model Generated Quantities (No Translation, Fitting in Log Space)
  geom_point(aes(x=x_cord, y=estimate), 
             data = TABI_KIF23_Log$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "blue", alpha=0.5) +
  #Plot in light green Model Generated Quantities (Vertical Translation, Fitting in Natural Space)
  geom_point(aes(x=x_cord, y=estimate),
             data = TABI_KIF23_Vert_Nat$generated_quantities %>%
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "light green", alpha=0.5) + 
    #Plot in red Model Generated Quantities (No Translation, Fitting in Natural Space)
  geom_point(aes(x=x_cord, y=estimate),
             data = TABI_KIF23_Nat$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "light blue", alpha=0.5) +
  #Scale log gene counts 
  scale_y_log10() +
  ggtitle("Red(Log Space, Vertical Trans), Blue (Log Space), Green(Vert Trans, Real Space), Light Blue (Real Space)" )


#Arrange each into separate plots for easy viewing 
#(high degree of overlap above makes it hard to ascertain improvements)

#Have the real data as base plot in all plots (in black)
base_plot <- Test_Real_KIF23 %>% 
  ggplot(aes(x=CAPRA_S, y=KIF23+1)) + 
  geom_point()


#Arrangement of plots as below
#Colours are same as above 
grid.arrange(p1 = base_plot + 
               geom_point(aes(x=x_cord, y=estimate), 
                          data = TABI_KIF23_Vert_Log$generated_quantities %>% 
                            ungroup() %>% 
                            mutate(x_cord = CAPRA_S), 
                          color = "red") +
               scale_y_log10(), 
             p2 = base_plot +
              geom_point(aes(x=x_cord, y=estimate), 
                         data = TABI_KIF23_Log$generated_quantities %>% 
                           ungroup() %>% 
                           mutate(x_cord = CAPRA_S), 
                         color = "blue") +
               scale_y_log10(),
             p3 = base_plot + 
               geom_point(aes(x=x_cord, y=estimate),
                          data = TABI_KIF23_Vert_Nat$generated_quantities %>%
                            ungroup() %>% 
                            mutate(x_cord = CAPRA_S), 
                          color = "light green") + 
               scale_y_log10(),
             p4 = base_plot +   
               geom_point(aes(x=x_cord, y=estimate),
                          data = TABI_KIF23_Nat$generated_quantities %>% 
                            ungroup() %>% mutate(x_cord = CAPRA_S), 
                          color = "light blue") +
               scale_y_log10(), 
             ncol=2, #Two rows, two columns of plots
             #Title labelling colours of each plot
             top = "Red(Log Space, Vertical Trans), Blue (Log Space), Green(Vert Trans, Real Space), Light Blue (Real Space)" ) 



```

# ANPEP

## Data Preparation for TABI 

```{r}
Test_Real_ANPEP<-PC_TCGA %>% 
  filter(transcript=="ANPEP") %>% 
  select(-transcript) %>% 
  rename(ANPEP= `read count normalised` , CAPRA_S = `CAPRA-S`) %>% 
  filter(is.na(CAPRA_S)==F, is.na(ANPEP)==F)

CAPRA_S <- Test_Real_ANPEP$CAPRA_S

#Plot gene count vs CAPRA_S score on log scale

Test_Real_ANPEP %>% ggplot(aes(x=CAPRA_S, y=ANPEP+1)) + 
  geom_point() + 
  scale_y_log10() + 
  labs(title="ANPEP Gene Count vs CAPRA_S")


# Plot gene count vs CAPRA_S score on natural scale 

Test_Real_ANPEP %>% ggplot(aes(x=CAPRA_S, y=ANPEP+1)) + 
  geom_point() + 
  labs(title="ANPEP Gene Count vs CAPRA_S")
```

## Run TABI

```{r}
# Model with vertical translation, fitting sigmoidal curve to log gene counts

TABI_ANPEP_Vert_Log<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_ANPEP, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_vert_log_space.stan", auto_write = F))
  

# Model with no vertical translation, fitting sigmoidal curve to log gene counts

TABI_ANPEP_Log<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_ANPEP, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_log_space.stan", auto_write = F))


# Model with vertical translation, fitting sigmoidal curve in the natural scale

TABI_ANPEP_Vert_Nat<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_ANPEP, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene.stan", auto_write = F))
rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene.stan", auto_write = F)


# Model with no vertical translation, fitting sigmoidal curve in the natural scale 

TABI_ANPEP_Nat<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_ANPEP, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_vert_trans.stan", auto_write = F))
```

## Posterior Diagnostic Checks 

```{r}
traceplot(TABI_ANPEP_Vert_Log$fit)

traceplot(TABI_ANPEP_Log$fit)

traceplot(TABI_ANPEP_Vert_Nat$fit)

traceplot(TABI_ANPEP_Nat$fit)
```

##  What does each TABI model estimate/sample for this gene? / How does this compare to the actual data?

```{r}
Test_Real_ANPEP %>% 
  ggplot(aes(x=CAPRA_S, y=ANPEP+1)) + 
  geom_point() + #Plot actual data for ANPEP in black points
  labs(title="", y="read count normalised") + 
  #Plot in red Model Generated Quantities (Vertical Translation, Fitting in Log Space)
  geom_point(aes(x=x_cord, y=estimate), 
             data = TABI_ANPEP_Vert_Log$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "red") + 
  #Plot in blue Model Generated Quantities (No Translation, Fitting in Log Space)
  geom_point(aes(x=x_cord, y=estimate), 
             data = TABI_ANPEP_Log$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "blue", alpha=0.5) +
  #Plot in light green Model Generated Quantities (Vertical Translation, Fitting in Natural Space)
  geom_point(aes(x=x_cord, y=estimate),
             data = TABI_ANPEP_Vert_Nat$generated_quantities %>%
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "light green", alpha=0.5) + 
    #Plot in red Model Generated Quantities (No Translation, Fitting in Natural Space)
  geom_point(aes(x=x_cord, y=estimate),
             data = TABI_ANPEP_Nat$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "light blue", alpha=0.5) +
  #Scale log gene counts 
  scale_y_log10() +
  ggtitle("Red(Log Space, Vertical Trans), Blue (Log Space), Green(Vert Trans, Real Space), Light Blue (Real Space)" )


#Arrange each into separate plots for easy viewing 
#(high degree of overlap above makes it hard to ascertain improvements)

#Have the real data as base plot in all plots (in black)
base_plot <- Test_Real_ANPEP %>% 
  ggplot(aes(x=CAPRA_S, y=ANPEP+1)) + 
  geom_point()


#Arrangement of plots as below
#Colours are same as above 
grid.arrange(p1 = base_plot + 
               geom_point(aes(x=x_cord, y=estimate), 
                          data = TABI_ANPEP_Vert_Log$generated_quantities %>% 
                            ungroup() %>% 
                            mutate(x_cord = CAPRA_S), 
                          color = "red") +
               scale_y_log10(), 
             p2 = base_plot +
              geom_point(aes(x=x_cord, y=estimate), 
                         data = TABI_ANPEP_Log$generated_quantities %>% 
                           ungroup() %>% 
                           mutate(x_cord = CAPRA_S), 
                         color = "blue") +
               scale_y_log10(),
             p3 = base_plot + 
               geom_point(aes(x=x_cord, y=estimate),
                          data = TABI_ANPEP_Vert_Nat$generated_quantities %>%
                            ungroup() %>% 
                            mutate(x_cord = CAPRA_S), 
                          color = "light green") +
               scale_y_log10(),
             p4 = base_plot +   
               geom_point(aes(x=x_cord, y=estimate),
                          data = TABI_ANPEP_Nat$generated_quantities %>% 
                            ungroup() %>% mutate(x_cord = CAPRA_S), 
                          color = "light blue") +
               scale_y_log10(), 
             ncol=2, #Two rows, two columns of plots
             #Title labelling colours of each plot
             top = "Red(Log Space, Vertical Trans), Blue (Log Space), Green(Vert Trans, Real Space), Light Blue (Real Space)" ) 



```

# LINC00668

## Data Preparation for TABI 

```{r}
Test_Real_LINC00668<-PC_TCGA %>% 
  filter(transcript=="LINC00668") %>% 
  select(-transcript) %>% 
  rename(LINC00668= `read count normalised` , CAPRA_S = `CAPRA-S`) %>% 
  filter(is.na(CAPRA_S)==F, is.na(LINC00668)==F)

CAPRA_S <- Test_Real_LINC00668$CAPRA_S

#Plot gene count vs CAPRA_S score on log scale

Test_Real_LINC00668 %>% ggplot(aes(x=CAPRA_S, y=LINC00668+1)) + 
  geom_point() + 
  scale_y_log10() + 
  labs(title="LINC00668 Gene Count vs CAPRA_S")


# Plot gene count vs CAPRA_S score on natural scale 

Test_Real_LINC00668 %>% ggplot(aes(x=CAPRA_S, y=LINC00668+1)) + 
  geom_point() + 
  labs(title="LINC00668 Gene Count vs CAPRA_S")
```

## Run TABI

```{r}
# Model with vertical translation, fitting sigmoidal curve to log gene counts

TABI_LINC00668_Vert_Log<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_LINC00668, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_vert_log_space.stan", auto_write = F))
  

# Model with no vertical translation, fitting sigmoidal curve to log gene counts

TABI_LINC00668_Log<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_LINC00668, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_log_space.stan", auto_write = F))


# Model with vertical translation, fitting sigmoidal curve in the natural scale

TABI_LINC00668_Vert_Nat<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_LINC00668, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene.stan", auto_write = F))
rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene.stan", auto_write = F)


# Model with no vertical translation, fitting sigmoidal curve in the natural scale 

TABI_LINC00668_Nat<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_LINC00668, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_vert_trans.stan", auto_write = F))
```

## Posterior Diagnostic Checks 

```{r}
traceplot(TABI_LINC00668_Vert_Log$fit)

traceplot(TABI_LINC00668_Log$fit)

traceplot(TABI_LINC00668_Vert_Nat$fit)

traceplot(TABI_LINC00668_Nat$fit)
```

##  What does each TABI model estimate/sample for this gene? / How does this compare to the actual data?

```{r}
Test_Real_LINC00668 %>% 
  ggplot(aes(x=CAPRA_S, y=LINC00668+1)) + 
  geom_point() + #Plot actual data for LINC00668 in black points
  labs(title="", y="read count normalised") + 
  #Plot in red Model Generated Quantities (Vertical Translation, Fitting in Log Space)
  geom_point(aes(x=x_cord, y=estimate), 
             data = TABI_LINC00668_Vert_Log$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "red") + 
  #Plot in blue Model Generated Quantities (No Translation, Fitting in Log Space)
  geom_point(aes(x=x_cord, y=estimate), 
             data = TABI_LINC00668_Log$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "blue", alpha=0.5) +
  #Plot in light green Model Generated Quantities (Vertical Translation, Fitting in Natural Space)
  geom_point(aes(x=x_cord, y=estimate),
             data = TABI_LINC00668_Vert_Nat$generated_quantities %>%
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "light green", alpha=0.5) + 
    #Plot in red Model Generated Quantities (No Translation, Fitting in Natural Space)
  geom_point(aes(x=x_cord, y=estimate),
             data = TABI_LINC00668_Nat$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "light blue", alpha=0.5) +
  #Scale log gene counts 
  scale_y_log10() +
  ggtitle("Red(Log Space, Vertical Trans), Blue (Log Space), Green(Vert Trans, Real Space), Light Blue (Real Space)" )


#Arrange each into separate plots for easy viewing 
#(high degree of overlap above makes it hard to ascertain improvements)

#Have the real data as base plot in all plots (in black)
base_plot <- Test_Real_LINC00668 %>% 
  ggplot(aes(x=CAPRA_S, y=LINC00668+1)) + 
  geom_point()


#Arrangement of plots as below
#Colours are same as above 
grid.arrange(p1 = base_plot + 
               geom_point(aes(x=x_cord, y=estimate), 
                          data = TABI_LINC00668_Vert_Log$generated_quantities %>% 
                            ungroup() %>% 
                            mutate(x_cord = CAPRA_S), 
                          color = "red") +
               scale_y_log10(), 
             p2 = base_plot +
              geom_point(aes(x=x_cord, y=estimate), 
                         data = TABI_LINC00668_Log$generated_quantities %>% 
                           ungroup() %>% 
                           mutate(x_cord = CAPRA_S), 
                         color = "blue") +
               scale_y_log10(),
             p3 = base_plot + 
               geom_point(aes(x=x_cord, y=estimate),
                          data = TABI_LINC00668_Vert_Nat$generated_quantities %>%
                            ungroup() %>% 
                            mutate(x_cord = CAPRA_S), 
                          color = "light green") +
               scale_y_log10(),
             p4 = base_plot +   
               geom_point(aes(x=x_cord, y=estimate),
                          data = TABI_LINC00668_Nat$generated_quantities %>% 
                            ungroup() %>% mutate(x_cord = CAPRA_S), 
                          color = "light blue") +
               scale_y_log10(), 
             ncol=2, #Two rows, two columns of plots
             #Title labelling colours of each plot
             top = "Red(Log Space, Vertical Trans), Blue (Log Space), Green(Vert Trans, Real Space), Light Blue (Real Space)" ) 



```

# NPY

## Data Preparation for TABI 

```{r}
Test_Real_NPY<-PC_TCGA %>% 
  filter(transcript=="NPY") %>%  #Select Gene of Interest
  select(-transcript) %>%  #Remove Name of Gene Column
  rename(NPY= `read count normalised` , CAPRA_S = `CAPRA-S`) %>% #Rename Columns for Data Access
  filter(is.na(CAPRA_S)==F, is.na(NPY)==F) #Remove Any NA Values

CAPRA_S <- Test_Real_NPY$CAPRA_S

#Plot gene count vs CAPRA_S score on log scale

Test_Real_NPY %>% ggplot(aes(x=CAPRA_S, y=NPY+1)) + 
  geom_point() + 
  scale_y_log10() + 
  labs(title="NPY Gene Count vs CAPRA_S")


# Plot gene count vs CAPRA_S score on natural scale 

Test_Real_NPY %>% ggplot(aes(x=CAPRA_S, y=NPY+1)) + 
  geom_point() + 
  labs(title="NPY Gene Count vs CAPRA_S")
```

## Run TABI

```{r}
# Model with vertical translation, fitting sigmoidal curve to log gene counts

TABI_NPY_Vert_Log<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_NPY, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_vert_log_space.stan", auto_write = F))
  

# Model with no vertical translation, fitting sigmoidal curve to log gene counts

TABI_NPY_Log<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_NPY, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_log_space.stan", auto_write = F))


# Model with vertical translation, fitting sigmoidal curve in the natural scale

TABI_NPY_Vert_Nat<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_NPY, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene.stan", auto_write = F))
rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene.stan", auto_write = F)


# Model with no vertical translation, fitting sigmoidal curve in the natural scale 

TABI_NPY_Nat<-TABI_glm(formula= ~CAPRA_S, 
                            data= Test_Real_NPY, 
                            prop_DE =0.1,
                            scale_DE = 5, 
                            model= rstan::stan_model("~/TABI/inst/stan/DE_sigmoid_one_gene_vert_trans.stan", auto_write = F))
```

## Posterior Diagnostic Checks 

```{r}
traceplot(TABI_NPY_Vert_Log$fit)

traceplot(TABI_NPY_Log$fit)

traceplot(TABI_NPY_Vert_Nat$fit)

traceplot(TABI_NPY_Nat$fit)
```

##  What does each TABI model estimate/sample for this gene? / How does this compare to the actual data?

```{r}
Test_Real_NPY %>% 
  ggplot(aes(x=CAPRA_S, y=NPY+1)) + 
  geom_point() + #Plot actual data for NPY in black points
  labs(title="", y="read count normalised") + 
  #Plot in red Model Generated Quantities (Vertical Translation, Fitting in Log Space)
  geom_point(aes(x=x_cord, y=estimate), 
             data = TABI_NPY_Vert_Log$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "red") + 
  #Plot in blue Model Generated Quantities (No Translation, Fitting in Log Space)
  geom_point(aes(x=x_cord, y=estimate), 
             data = TABI_NPY_Log$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "blue", alpha=0.5) +
  #Plot in light green Model Generated Quantities (Vertical Translation, Fitting in Natural Space)
  geom_point(aes(x=x_cord, y=estimate),
             data = TABI_NPY_Vert_Nat$generated_quantities %>%
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "light green", alpha=0.5) + 
    #Plot in red Model Generated Quantities (No Translation, Fitting in Natural Space)
  geom_point(aes(x=x_cord, y=estimate),
             data = TABI_NPY_Nat$generated_quantities %>% 
               ungroup() %>% 
               mutate(x_cord = CAPRA_S), 
             color = "light blue", alpha=0.5) +
  #Scale log gene counts 
  scale_y_log10() +
  ggtitle("Red(Log Space, Vertical Trans), Blue (Log Space), Green(Vert Trans, Real Space), Light Blue (Real Space)" )


#Arrange each into separate plots for easy viewing 
#(high degree of overlap above makes it hard to ascertain improvements)

#Have the real data as base plot in all plots (in black)
base_plot <- Test_Real_NPY %>% 
  ggplot(aes(x=CAPRA_S, y=NPY+1)) + 
  geom_point()


#Arrangement of plots as below
#Colours are same as above 
grid.arrange(p1 = base_plot + 
               geom_point(aes(x=x_cord, y=estimate), 
                          data = TABI_NPY_Vert_Log$generated_quantities %>% 
                            ungroup() %>% 
                            mutate(x_cord = CAPRA_S), 
                          color = "red") +
               scale_y_log10(), 
             p2 = base_plot +
              geom_point(aes(x=x_cord, y=estimate), 
                         data = TABI_NPY_Log$generated_quantities %>% 
                           ungroup() %>% 
                           mutate(x_cord = CAPRA_S), 
                         color = "blue") + 
               scale_y_log10(),
             p3 = base_plot + 
               geom_point(aes(x=x_cord, y=estimate),
                          data = TABI_NPY_Vert_Nat$generated_quantities %>%
                            ungroup() %>% 
                            mutate(x_cord = CAPRA_S), 
                          color = "light green") +
               scale_y_log10(),
             p4 = base_plot +   
               geom_point(aes(x=x_cord, y=estimate),
                          data = TABI_NPY_Nat$generated_quantities %>% 
                            ungroup() %>% mutate(x_cord = CAPRA_S), 
                          color = "light blue") +
               scale_y_log10(), 
             ncol=2, #Two rows, two columns of plots
             #Title labelling colours of each plot
             top = "Red(Log Space, Vertical Trans), Blue (Log Space), Green(Vert Trans, Real Space), Light Blue (Real Space)" ) 

```



