---
title: "TABI Test on Data"
author: "Isobel Beasley"
date: "Last Updated 6/12/2019"
output:
html_document: 
  toc: yes
  toc_depth: 3
  number_sections: true
  theme: readable
  highlight: null
---
## Load Required Packages

```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(rstan)
#TABI
if("package:TABI" %in% search()) detach("package:TABI", unload=TRUE, force=TRUE); library(TABI)  
```

# Test on False Positive Data 

Note: (True Positive Curve Shape was inspired by results/estimated fit from TABI run on gene NUSAP1). 

## *Create Simulation Data*

## Create Generalised Sigmoid Function Equation

```{r, fig.height=8, fig.width=9}
#Create Generalised Sigmoid Function Equation
eq <- function(x) {
	eta=2
	beta=3
	y_0=600
	top<- (y_0*(1+exp(eta*beta)))
	bottom<-(1+exp(eta*beta-x*beta))
	return(top/bottom)
}

#For plotting  add + 1 (prevent issues with log transformation)
eq1 <- function(x) {
	eta=2.29
	beta=0.9
	y_0=600
	top<- (y_0*(1+exp(eta*beta)))
	bottom<-(1+exp(eta*beta-x*beta))
	return(top/bottom+1)
	}

#Plot function normal scale

ggplot(data.frame(x=c(0,8)), aes(x=x)) + stat_function(fun=eq1, geom="line")	+ labs(title="True Positive Curve", x="CAPRA-S", y="Normalised Gene Count")
#Plot Function log scale
ggplot(data.frame(x=c(0,8)), aes(x=x)) + stat_function(fun=eq1, geom="line") + scale_y_log10()	+ labs(title="True Positive Curve (Log Transformed Scale)", x="CAPRA-S", y="Normalised Gene Count")
```

```{r, include= FALSE, eval=FALSE}
## Create number of samples expected for each CAPRA-S level
#Distribution of CAPRA-S Scores
k<-0
for (i in 0:8) {
f<-PC_TCGA %>% filter(transcript=="NUSAP1")
k[i]<-sum(f$`CAPRA-S`==i, na.rm=T)}
k #Number of sample from Each CAPRA-S Score
```

## Find expected value for each CAPRA-S level (i.e. using the defined equation above)

```{r, fig.height=8, fig.width=9}
y_exp<-sapply(seq(from=0, to=8, by=0.1), FUN=eq) #Expected Value for each CAPRA_S score
x_val=seq(from=0, to=8, by=0.1)
data.frame(x_val=seq(from=0, to=8, by=0.1), y_exp) %>% ggplot(aes(y=y_exp, x=x_val)) + geom_point()  + stat_function(fun=eq, geom="line")
```



## Use these values to simulate test data 

```{r}
y_sim<- rnbinom(length(y_exp), mu=y_exp, size=30)  
data.frame(x_val=seq(from=0, to=8, by=0.1), y_sim) %>% ggplot(aes(x=x_val, y=y_sim)) +geom_point() +  stat_function(fun=eq, geom="line")
```

```{r, include=FALSE, eval=FALSE}
# Old Method for Array
## Use these values to simulate test data 
#Take stardard normal (multiply by 500, giving sd of 500), then shift so that its mean value is the expected value
#A a particular CAPRA_S score, take n number of random samples from the resulting distribution 
y_sim<-apply(array(c(y,k), dim=c(8,2)), MARGIN=1, FUN=function(x) { rnorm(n=x[2],mean(x[1]),sd=500)})
#Define corresponding CAPRA_S
CAPRA_S<-c(rep(0,11), rep(1,13), rep(2,23), rep(3,11), rep(4,47), rep(5,5), rep(6,18), rep(7,2))
#Resulting Distribution of Simulated Gene Counts
hist(as.integer(unlist(y_sim)), main="Distribution of Simulated Normalised Gene Counts")
```


## Run TABI on the simulated Data 

```{r,message=FALSE, warning=FALSE}
Test_TP<-data.frame(CAPRA_S=seq(from=0, to=8, by=0.1), y_sim_gene = y_sim)

TABI_TP<-TABI_glm(formula= ~CAPRA_S, #Include covariates with + 
												 data= Test_TP, prop_DE =0.1, scale_DE = 5, model=rstan::stan_model("~/PhD/TABI/src/stan_files/DE_sigmoid.stan")
)
```

## Posterior Diagnositc/Mixing Check
```{r, message=FALSE, warning=FALSE}
traceplot(TABI_TP$fit,inc_warmup=T)

```

## Is the simulated gene detected as significantly associated with CAPRA-S? 

```{r, message=FALSE, warning=FALSE}
plot_posterior(TABI_TP, CI=0.95)
```

## What does TABI think are the values of the parameters? 

**Actual Values** `eta=2.29, beta=0.9, y_0=600` (`log_y0` =`r log(600)`)

```{r}
#Parameter Estimates
summary(TABI_TP$fit)
get_posterior_mean(TABI_TP$fit)[1:5,]
```

```{r, message=FALSE, warning=FALSE}
plot(TABI_TP$fit, pars=c("inflection[1]", "log_y_cross[1]", "beta1_z[1,1]"), ci_level = 0.8, outer_level = 0.95) + ggtitle("Posterior Parameter Intervals")
TABI_TP$generated_quantities %>% ungroup() %>% mutate(x_cord = x_val) %>%
 ggplot(aes(x=x_cord, y=estimate)) +geom_point()
names()
```
