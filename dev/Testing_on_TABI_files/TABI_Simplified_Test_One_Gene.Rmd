---
title: "TABI Test on Data"
author: "Isobel Beasley"
date: "Last Updated 12/12/2019"
output:
html_document: 
  toc: yes
  toc_depth: 3
  number_sections: true
  theme: readable
  highlight: null
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE, fig.height=10, fig.width = 12, warning=FALSE, message=FALSE, eval = TRUE, fig.show=TRUE, fig.align='center', out.width = '100%')
```

## Load Required Packages

```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(rstan)
library(bayesplot)
#TABI
if("package:TABI" %in% search()) detach("package:TABI", unload=TRUE, force=TRUE); library(TABI)  

#Required TCGA (Data, just transcript, CAPRA_S, and normalised gene count columns)
load("/stornext/Home/data/allstaff/b/beasley.i/TABI/dev/PC_TCGA.rda")
```

# (1) How does the model change with changing paramters? (Single Gene)

## (1.1) Changing Beta 

```{r}
#Create Generalised Sigmoid Function (Reparameterised)
eq_test <- function(x, y_0, eta, beta) {
	top<- (y_0*(1+exp(eta*beta)))
	bottom<-(1+exp(eta*beta-x*beta))
	top/bottom
}


beta<-seq(from=-2, to=2, by=0.25) #What beta values to evaluate
x = seq(from=-5, to=5, by=0.01) #Range of x values 
y0<-seq(from=0, to=10, by=1) #Range of y0 values
eta<-2

#For x values, y0=0, eta=2 plot first beta
plot(x=x, y=eq_test(x,5,2,beta[1]), type="line")

#Plot lines for the rest of the possible betas
for (i in 1:length(beta)) {
(lines(x=x, y=eq_test(x,5,2, beta[i])))}


#Note that eta (x axis value of inflection point doesn't change when beta changes, beta is the slope)
```

## (1.2) Change y0 

```{r}
#Plot for first y0
plot(x=x, y=eq_test(x, y0[1], 2, 2), type="line" )

#Add lines for all other y0 values
for (i in 1:length(y0)) {
lines(x=x, y=eq_test(x, y0[i], 2, 2) )
  }


#Note that eta (x axis value of inflection point doesn't change when y0 changes, it only changes the slope)
#Potetional problem when y0 is less than zero, may caue intrepretation problems with beta (i.e. is decreasing or increasing)

```

# (2) Test on False Positive Data 

## (2.1) *Create Simulation Data*

### (2.1.1) Create Generalised Sigmoid Function Equation

```{r, fig.height=8, fig.width=9}
#Create Generalised Sigmoid Function Equation
eq <- function(x) {
	eta=1
	beta=3
	y_0=600
	top<- (y_0*(1+exp(eta*beta)))
	bottom<-(1+exp(eta*beta-x*beta))
	return(top/bottom)
}

#Plot function
ggplot(data.frame(x=c(0,8)), aes(x=x)) + stat_function(fun=eq, geom="line")	+ labs(title="True Positive Curve", x="CAPRA-S", y="Normalised Gene Count")
```

### (2.1.2) Find expected value for each CAPRA-S level (i.e. using the defined equation above)

```{r, fig.height=8, fig.width=9}
y_exp<-sapply(seq(from=0, to=8, by=0.1), FUN=eq) #Expected Value for each CAPRA_S score
x_val=seq(from=0, to=8, by=0.1) 
data.frame(x_val=seq(from=0, to=8, by=0.1), y_exp) %>% ggplot(aes(y=y_exp, x=x_val)) + geom_point() 
```

### (2.1.3) Use these values to simulate test data 

```{r}
#Simulate test data with negative binomial distributed genes count
y_sim<- rnbinom(length(y_exp), mu=y_exp, size=30)  
data.frame(x_val=seq(from=0, to=8, by=0.1), y_sim) %>% ggplot(aes(x=x_val, y=y_sim)) +geom_point() +  stat_function(fun=eq, geom="line")
```

### (2.1.4) Run TABI on the simulated Data 

```{r,message=FALSE, warning=FALSE}
Test_TP<-data.frame(CAPRA_S=seq(from=0, to=8, by=0.1), y_sim_gene = y_sim)

TABI_TP<-TABI_glm(formula= ~CAPRA_S, 
												 data= Test_TP, prop_DE =0.1, scale_DE = 5, model=rstan::stan_model("~/PhD/TABI/src/stan_files/DE_sigmoid.stan")
)
```

### (2.1.5) Posterior Diagnositc/Mixing Check

```{r, message=FALSE, warning=FALSE}

traceplot(TABI_TP$fit,inc_warmup=F)
np <- nuts_params(TABI_TP$fit)
mcmc_parcoord(TABI_TP$fit, transform = function(x) {(x - mean(x)) / sd(x)},size = 0.25, alpha = 0.1, div_color ="red", np=np)
```

### (2.1.6) Is the simulated gene detected as significantly associated with CAPRA-S? 

```{r, message=FALSE, warning=FALSE}
plot_posterior(TABI_TP, CI=0.95)
```

### (2.1.7) What does TABI think are the values of the parameters? 

**Actual Values** `eta=1, beta=3, y_0=600` (`log_y0` =`r log(600)`)

```{r}
#Parameter Estimates
get_posterior_mean(TABI_TP$fit)[1:5,]

plot(TABI_TP$fit, pars=c("inflection[1]", "log_y_cross[1]", "beta1_z[1,1]"), ci_level = 0.8, outer_level = 0.95) + ggtitle("Posterior Parameter Intervals")
```

```{r, message=FALSE, warning=FALSE}
plot(TABI_TP$fit, pars=c("inflection[1]", "log_y_cross[1]", "beta1_z[1,1]"), ci_level = 0.8, outer_level = 0.95) + ggtitle("Posterior Parameter Intervals")

TABI_TP$generated_quantities %>% ungroup() %>% mutate(x_cord = x_val) %>% ggplot(aes(x=x_cord, y=estimate)) +geom_point()

```

# (3) Test on Real Gene Data 

## (3.1) CDKN2B

### (3.1.1) Data Preparation for TABI 

```{r, cache=T}
#Filter out on CDKN2B
Test_Real_CDKN2B<-PC_TCGA %>% filter(transcript=="CDKN2B") %>% select(-transcript) %>% rename(CDKN2B= `read count normalised` , CAPRA_S = `CAPRA-S`) %>% filter(is.na(CAPRA_S)==F, is.na(CDKN2B)==F)

#Define CAPRA_S
CAPRA_S <- Test_Real_CDKN2B$CAPRA_S

```

### (3.1.2) Run TABI 

```{r}
TABI_CDKN2B<-TABI_glm(formula= ~CAPRA_S, #Include covariates with + 
												 data= Test_Real_CDKN2B, prop_DE =0.1, scale_DE = 5, model=rstan::stan_model("~/PhD/TABI/src/stan_files/DE_sigmoid.stan")
)
```

### (3.1.3) Posterior Diagnositc/Mixing Check

```{r}
traceplot(TABI_CDKN2B$fit)

np1 <- nuts_params(TABI_CDKN2B$fit)
mcmc_parcoord(TABI_CDKN2B$fit, transform = function(x) {(x - mean(x)) / sd(x)},size = 0.25, alpha = 0.1, div_color ="red", np=np1)
```

### (3.1.4) What does TABI think are the parameters? 

```{r}
get_posterior_mean(TABI_CDKN2B$fit)[1:5,]

plot(TABI_CDKN2B$fit, pars=c("inflection[1]", "log_y_cross[1]", "beta1_z[1,1]"), ci_level = 0.8, outer_level = 0.95) + ggtitle("Posterior Parameter Intervals")
```

### (3.1.5) Is the gene detected as significantly associated with CAPRA-S? 

```{r, message=FALSE, warning=FALSE}
plot_posterior(TABI_CDKN2B, CI=0.95)
```

### (3.1.6) What does TABI estimate/sample for this gene? / How does this compare to the actual data?

```{r}
Test_Real_CDKN2B %>% ggplot(aes(x=CAPRA_S, y=CDKN2B)) + geom_point() +labs(title="CDKN2B", y="read count normalised") + geom_point(aes(x=x_cord, y=estimate), data = TABI_CDKN2B$generated_quantities %>% ungroup() %>% mutate(x_cord = CAPRA_S), color = "red")
```

## (3.2) KIF23

### (3.2.1) Data Preparation for TABI 

```{r, cache=T}
#Filter out on KIF23
Test_Real_KIF23<-PC_TCGA %>% filter(transcript=="KIF23") %>% select(-transcript) %>% rename(KIF23= `read count normalised` , CAPRA_S = `CAPRA-S`) %>% filter(is.na(CAPRA_S)==F, is.na(KIF23)==F)

#Define CAPRA_S
CAPRA_S <- Test_Real_KIF23$CAPRA_S

```

### (3.1.2) Run TABI 

```{r}
TABI_KIF23<-TABI_glm(formula= ~CAPRA_S, #Include covariates with + 
												 data= Test_Real_KIF23, prop_DE =0.1, scale_DE = 5, model=rstan::stan_model("~/PhD/TABI/src/stan_files/DE_sigmoid.stan")
)
```

### (3.2.3) Posterior Diagnositc/Mixing Check

```{r}
traceplot(TABI_KIF23$fit)

np2 <- nuts_params(TABI_KIF23$fit)
mcmc_parcoord(TABI_KIF23$fit, transform = function(x) {(x - mean(x)) / sd(x)},size = 0.25, alpha = 0.1, div_color ="red", np=np2)

```

### (3.2.4) What does TABI think are the parameters? 

```{r}
get_posterior_mean(TABI_KIF23$fit)[1:5,]

plot(TABI_KIF23$fit, pars=c("inflection[1]", "log_y_cross[1]", "beta1_z[1,1]"), ci_level = 0.8, outer_level = 0.95) + ggtitle("Posterior Parameter Intervals")
```

### (3.2.5) Is the gene detected as significantly associated with CAPRA-S? 

```{r, message=FALSE, warning=FALSE}
plot_posterior(TABI_KIF23, CI=0.95)
```

### (3.2.6) What does TABI estimate/sample for this gene? / How does this compare to the actual data?

```{r}
Test_Real_KIF23 %>% ggplot(aes(x=CAPRA_S, y=KIF23)) + geom_point() +labs(title="KIF23", y="read count normalised") + geom_point(aes(x=x_cord, y=estimate), data = TABI_KIF23$generated_quantities %>% ungroup() %>% mutate(x_cord = CAPRA_S), color = "red")
```
